<Window x:Class="LightAddonApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:LightAddonApp"
        xmlns:h="clr-namespace:HelixToolkit.Wpf;assembly=HelixToolkit.Wpf"
        mc:Ignorable="d"
        Title="STL Viewer - LightAddon"
        Height="700"
        Width="1200"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Border Grid.Row="0"
                Background="{StaticResource App.SurfaceBrush}"
                BorderBrush="{StaticResource App.BorderBrush}"
                BorderThickness="0,0,0,1">
            <DockPanel Margin="8,6">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Button Click="OpenStl_Click" Content="Открыть STL"/>
                    <Button Click="ResetCamera_Click" Content="Сбросить камеру"/>
                    <Button x:Name="RaytraceButton" Click="RaytraceButton_Click" Content="Запустить рейтрейсинг"/>
                </StackPanel>
                <TextBlock Text="3D STL Viewer"
                           Style="{StaticResource ToolbarLabel}"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Right"
                           DockPanel.Dock="Right"/>
            </DockPanel>
        </Border>

        <Border Grid.Row="1"
                Background="{StaticResource App.BackgroundBrush}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="280"/>
                </Grid.ColumnDefinitions>
                
                <!-- Левая панель - Дерево модели и Источники света -->
                <Border Grid.Column="0"
                        Background="{StaticResource App.SurfaceBrush}"
                        BorderBrush="{StaticResource App.BorderBrush}"
                        BorderThickness="0,0,1,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="250"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Дерево модели -->
                        <TextBlock Text="Дерево модели"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Foreground="{StaticResource App.TextBrush}"
                                   Margin="12,8,12,4"
                                   Grid.Row="0"/>
                        <TreeView x:Name="ModelTreeView"
                                  Grid.Row="1"
                                  BorderThickness="0"
                                  Background="Transparent"
                                  Foreground="{StaticResource App.TextBrush}"
                                  SelectedItemChanged="ModelTreeView_SelectedItemChanged"
                                  Margin="0,0,0,8">
                            <TreeView.Resources>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="IsExpanded" Value="True"/>
                                    <Setter Property="Foreground" Value="{StaticResource App.TextBrush}"/>
                                </Style>
                            </TreeView.Resources>
                        </TreeView>
                        
                        <!-- Разделитель -->
                        <Border Grid.Row="2"
                                BorderBrush="{StaticResource App.BorderBrush}"
                                BorderThickness="0,1,0,0"
                                Margin="8,0"/>
                        
                        <!-- Источники света -->
                        <Grid Grid.Row="3">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Text="Источники света"
                                       FontWeight="SemiBold"
                                       FontSize="14"
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="12,8,12,4"
                                       Grid.Row="0"/>
                            
                            <StackPanel Orientation="Horizontal" 
                                        Margin="12,0,12,8"
                                        Grid.Row="1">
                                <Button x:Name="AddLightButton"
                                        Content="+ Добавить"
                                        Click="AddLightButton_Click"
                                        Padding="8,4"
                                        Margin="0,0,4,0"/>
                                <Button x:Name="ToggleRaysButton"
                                        Content="Лучи: Выкл"
                                        Click="ToggleRaysButton_Click"
                                        Padding="8,4"/>
                            </StackPanel>
                            
                            <ListBox x:Name="LightsListBox"
                                     Grid.Row="2"
                                     BorderThickness="0"
                                     Background="Transparent"
                                     Foreground="{StaticResource App.TextBrush}"
                                     SelectionChanged="LightsListBox_SelectionChanged"
                                     Margin="12,0,12,8">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" 
                                                   Foreground="{StaticResource App.TextBrush}"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Grid>
                </Border>
                
                <!-- Центральная панель - 3D Viewport -->
                <h:HelixViewport3D x:Name="Viewport"
                                   Grid.Column="1"
                                   ZoomExtentsWhenLoaded="True"
                                   ShowViewCube="True"
                                   ViewCubeOpacity="0.7"
                                   ShowCoordinateSystem="False"
                                   IsHeadLightEnabled="False"
                                   Background="{StaticResource App.BackgroundBrush}"
                                   RotateAroundMouseDownPoint="False"
                                   ChangeFieldOfViewCursor="SizeNS"
                                   PanCursor="Hand"
                                   RotateCursor="SizeAll"
                                   ModelUpDirection="0,1,0">
                    <h:HelixViewport3D.Camera>
                        <PerspectiveCamera Position="10,10,10"
                                           LookDirection="-10,-10,-10"
                                           UpDirection="0,1,0"
                                           FieldOfView="45"/>
                    </h:HelixViewport3D.Camera>

                    <ModelVisual3D>
                        <ModelVisual3D.Content>
                            <Model3DGroup>
                                <AmbientLight Color="#202020" />
                                <DirectionalLight Color="#DDDDDD" Direction="-1,-1,-1"/>
                                <DirectionalLight Color="#777777" Direction="1,1,0.5"/>
                            </Model3DGroup>
                        </ModelVisual3D.Content>
                    </ModelVisual3D>

                    <ModelVisual3D x:Name="ModelContainer" />

                    <h:GridLinesVisual3D Center="0,0,0"
                                          Normal="0,1,0"
                                          Length="1000"
                                          Width="1000"
                                          MinorDistance="10"
                                          MajorDistance="50"
                                          Thickness="0.08"
                                          Fill="#CCFFFFFF" />
                </h:HelixViewport3D>
                
                <!-- Правая панель - Управление перемещением -->
                <Border Grid.Column="2"
                        Background="{StaticResource App.SurfaceBrush}"
                        BorderBrush="{StaticResource App.BorderBrush}"
                        BorderThickness="1,0,0,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel x:Name="TransformPanel" Margin="12" Orientation="Vertical">
                            <TextBlock Text="Перемещение"
                                       FontWeight="SemiBold"
                                       FontSize="14"
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="0,0,0,8"/>
                            
                            <TextBlock x:Name="SelectedItemLabel"
                                       Text="Ничего не выбрано"
                                       Foreground="{StaticResource App.TextSecondaryBrush}"
                                       Margin="0,0,0,12"
                                       TextWrapping="Wrap"/>
                            
                            <TextBlock Text="Позиция X:" 
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="0,4,0,2"/>
                            <Slider x:Name="PositionX"
                                    Minimum="-100"
                                    Maximum="100"
                                    TickFrequency="1"
                                    IsSnapToTickEnabled="False"
                                    ValueChanged="PositionChanged"
                                    Margin="0,0,0,4"/>
                            <TextBox x:Name="PositionXText"
                                     Text="{Binding Value, ElementName=PositionX, StringFormat=F2}"
                                     IsReadOnly="True"
                                     Background="{StaticResource App.BackgroundBrush}"
                                     BorderBrush="{StaticResource App.BorderBrush}"
                                     Foreground="{StaticResource App.TextBrush}"
                                     Padding="4"
                                     Margin="0,0,0,12"/>
                            
                            <TextBlock Text="Позиция Y:" 
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="0,4,0,2"/>
                            <Slider x:Name="PositionY"
                                    Minimum="-100"
                                    Maximum="100"
                                    TickFrequency="1"
                                    IsSnapToTickEnabled="False"
                                    ValueChanged="PositionChanged"
                                    Margin="0,0,0,4"/>
                            <TextBox x:Name="PositionYText"
                                     Text="{Binding Value, ElementName=PositionY, StringFormat=F2}"
                                     IsReadOnly="True"
                                     Background="{StaticResource App.BackgroundBrush}"
                                     BorderBrush="{StaticResource App.BorderBrush}"
                                     Foreground="{StaticResource App.TextBrush}"
                                     Padding="4"
                                     Margin="0,0,0,12"/>
                            
                            <TextBlock Text="Позиция Z:" 
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="0,4,0,2"/>
                            <Slider x:Name="PositionZ"
                                    Minimum="-100"
                                    Maximum="100"
                                    TickFrequency="1"
                                    IsSnapToTickEnabled="False"
                                    ValueChanged="PositionChanged"
                                    Margin="0,0,0,4"/>
                            <TextBox x:Name="PositionZText"
                                     Text="{Binding Value, ElementName=PositionZ, StringFormat=F2}"
                                     IsReadOnly="True"
                                     Background="{StaticResource App.BackgroundBrush}"
                                     BorderBrush="{StaticResource App.BorderBrush}"
                                     Foreground="{StaticResource App.TextBrush}"
                                     Padding="4"
                                     Margin="0,0,0,12"/>
                            
                            <Button Click="ResetPosition_Click" Content="Сбросить позицию" Margin="0,8,0,0"/>
                            
                            <TextBlock Text="Управление:"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource App.TextBrush}"
                                       Margin="0,16,0,4"/>
                            <TextBlock TextWrapping="Wrap"
                                       Foreground="{StaticResource App.TextSecondaryBrush}"
                                       FontSize="11"
                                       Margin="0,0,0,4">
                                <Run Text="• ЛКМ + перетаскивание - вращение камеры"/>
                                <LineBreak/>
                                <Run Text="• СКМ + перетаскивание - перемещение камеры"/>
                                <LineBreak/>
                                <Run Text="• Колесико мыши - масштаб (адаптивный)"/>
                                <LineBreak/>
                                <Run Text="• WASD - движение камеры (адаптивное)"/>
                                <LineBreak/>
                                <Run Text="• Q/E - вверх/вниз"/>
                                <LineBreak/>
                                <Run Text="• ЛКМ по модели - выбор"/>
                                <LineBreak/>
                                <Run Text="• ViewCube - ориентация камеры"/>
                            </TextBlock>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>

        <Border Grid.Row="2"
                Background="{StaticResource App.SurfaceBrush}"
                BorderBrush="{StaticResource App.BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="8,4">
            <DockPanel>
                <TextBlock x:Name="StatusText"
                           Text="Готово. Нажмите &quot;Открыть STL&quot; чтобы загрузить модель."
                           Foreground="{StaticResource App.TextSecondaryBrush}"
                           VerticalAlignment="Center"/>
            </DockPanel>
        </Border>
    </Grid>
</Window>
